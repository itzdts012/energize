#cloud-config
package_update: true
package_upgrade: true
packages:
  - docker.io
  - docker-compose
  - nginx
  - certbot
  - python3-certbot-nginx
  - ufw
  - curl

runcmd:
  # Docker setup
  - systemctl start docker
  - systemctl enable docker
  - usermod -aG docker ubuntu
  
  # Firewall
  - ufw allow OpenSSH
  - ufw allow 'Nginx Full'
  - ufw --force enable
  
  # NGINX reverse proxy
  - |
    cat > /etc/nginx/sites-available/default << EOF
server {
    listen 80;
    server_name _;
    location / {
        proxy_pass http://localhost:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_cache_bypass \$http_upgrade;
    }
}
EOF
  - nginx -t && systemctl restart nginx
  
  # Coolify installer (self-hosted deployer)
  - curl -fsSL https://cdn.coollabs.io/coolify/install.sh | bash
  
  # Auto-start Coolify
  - systemctl enable coolify
  - systemctl start coolify
  
  # Reboot after setup
  - reboot

write_files:
  - path: /root/setup-complete
    content: Coolify installed! Access https://YOUR_IP (admin@coolify.io / coolify)
